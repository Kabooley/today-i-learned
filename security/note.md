# 体系的に学ぶ 安全なWebアプリケーションの作り方 第2版

## 環境を整えるにあたって

テキストに従ってくれ。

よ～く読んでやらないとうまくいかん。

## 3. Webセキュリティの基礎

HTTPはクライアントの現在の状態を記憶しておくことがない。

HTTPはステートレスである。

なのでHTTPはどうやって状態を記憶させているのか。

このため、レスポンスの`hidden`パラメータ内に状態を記録している。

このhiddenパラメータはブラウザ上では書き換え不可能な値であるが、

HTTP通信を傍受できれば簡単に書き換え変更できる。

もっというとhiddenパラメータに限らずHTTPレイヤーでは書き換え可能である。

OWASPZAPのようなプロキシツールを用いると簡単に変更できてしまう。

#### hiddenパラメータは脆弱ではないのか？

`hidden`パラメータは利用者自身が変更はできる隙があるけれど、

情報漏洩や第三者からは堅牢である。

つまり利用者以外は手出しができないのである。

`hidden`パラメータには、利用者自身によっては書き換えられては困る情報は保存しないで、

それ以外の情報は保存することを検討してもいいかも。

その辺がCookieやセッションと比較するポイント。

#### ステートレスなHTTP認証

BASIC認証:

認証が必要なページへのリクエスト

サーバは401を返す。

これをうけてブラウザは認証情報を求める入力画面を表示する

ユーザがIDやパスワードを入力する

ブラウザが入力情報を含めて改めてリクエストする

サーバは認証情報を検証する。

basic認証が通ったときのリクエストヘッダには

`Authorization: Basic dXNlcjE6cGFzczE=`が付与されている

これはログイン情報として入力した情報（ユーザIDやパスワード）をBase64エンコードしたものである。

以降、

そのURL（https://example.jp/31/）以下のURLへのリクエストには、

ブラウザは自動的に`Authorization`ヘッダを自動的に付与してくれるので

いちいち認証なしでアクセスできる。

裏側では、

リクエストのたびにIDとパスワードを送信しているので認証情報はどこにも保存されておらず

リクエストのたびにAuthorizationで付与している。

まとめ：

- Basic認証はステートレスなのでサーバ側で認証情報を保存しない
- 認証はリクエストに`Authorization`というIDとパスワードをBase64でエンコードした情報を毎回送信することで実現している


#### クッキーとセッション管理

アプリケーションの状態を覚えておくことをセッション管理と呼ぶ

クッキーはサーバ側からブラウザに対して「名前＝変数」の組を覚えておくように指示するものである。

クッキーを使って認証情報を得る場合は

認証画面ページのレスポンスに

`Set-Cookie: PHPSESSID=d55olpd39rra2jgou3686odrq1; path=/`

が含まれる。

認証情報を送る時のリクエストには次が追加される。

`Cookie: PHPSESSID=d55olpd39rra2jgou3686odrq1`

ひとたび認証が通れば

以降のそのURL（example.jp)へアクセスするときはブラウザがCookieを送信してアクセスする

ということで、

Cookieを使うとブラウザはセッションIDを保持することになる。

セッションID：`PHPSESSID=d55olpd39rra2jgou3686odrq1`

Cookieは大きなデータを保持するのに向いていないため

実際の値はサーバが管理しブラウザはその値に結びつくセッションIDを送信することでアクセスできるようになる

セッションIDは容易に想像がつく値であると他人に簡単になりすますことができてしまう。

セッションIDさえ送信すればサーバは通してしまうからである。

セッションIDを生成するのはCookieのセキュリティに関わる重要な部分なので

その乱数生成と暗号化は自作するべきでない。

